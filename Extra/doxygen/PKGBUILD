#-*-mode:sh-*-
pkgbase=doxygen
pkgname=('doxygen')
pkgver=1.8.14
pkgrel=1
pkgdesc='Documentation system for C++, C, Java, IDL and PHP'
url='http://www.doxygen.org/'
arch=('x86_64')
license=('GPL')
_makedeps=('qt5-base' 'texlive-core' 'ghostscript' 'texlive-latexextra' 'graphviz')
makedepends=('cmake' 'gcc-libs' 'flex' 'python2')
source=(${pkgbase}-${pkgver}.tar.gz::https://github.com/doxygen/doxygen/archive/Release_${pkgver//./_}.tar.gz)
sha256sums=('18bc3790b4d5f4d57cb8ee0a77dd63a52518f3f70d7fdff868a7ce7961a6edc3')
sha512sums=('e19d706be64f8c1d35d3cd12b8c35f09503213bb3f5a4aa311ef0a6a953843ebed5ac4eca52ca908222543fb9794d545bb6d88c9fc8f39e66ef22c1919c120b0')

for _m in "${_makedeps[@]}";do
  if [[ -n "$(pacman -Ss "^${_m}$" 2>/dev/null)" ]];then
    makedepends+=( "${_m}")
    pkgname+=( 'doxygen-docs')
  fi
done

prepare() {
  cd ${pkgbase}-Release_${pkgver//./_}

  mkdir build

  # Install the man pages in the right place
  sed -i 's:DESTINATION man/man1:DESTINATION "${CMAKE_INSTALL_PREFIX}/share/man/man1":g' \
      doc/CMakeLists.txt

  cd build
  _confargs=("-DCMAKE_INSTALL_PREFIX:PATH=/usr" "-DPYTHON_EXECUTABLE:FILE=/usr/bin/python2")
  if [[ -n "$(pacman -Qq "${_m}" 2>/dev/null)" ]];then
    _confargs+=( "-Dbuild_doc:BOOL=ON" "-Dbuild_wizard:BOOL=ON" "-DDOC_INSTALL_DIR:PATH=share/doc/doxygen")
  fi

  cmake .. ${_confargs[@]}
}

build() {
  cd ${pkgbase}-Release_${pkgver//./_}/build
  make
  if [[ -n "$(pacman -Qq "${_m}" 2>/dev/null)" ]];then
    make docs
  fi
}

check(){
  cd ${pkgbase}-Release_${pkgver//./_}/build
  make tests
}

package_doxygen() {
  pkgdesc='Documentation system for C++, C, Java, IDL and PHP'
  depends=('gcc-libs')
  optdepends=('graphviz: for caller/callee graph generation'
              'qt5-base: for doxywizard')

  cd ${pkgbase}-Release_${pkgver//./_}/build
  make DESTDIR="${pkgdir}" install

  # Docs are in 'doxygen-docs'
  rm -rf "${pkgdir}/usr/share/doc"
}

package_doxygen-docs() {
  pkgdesc='Developer documentation for doxygen'

  cd ${pkgbase}-Release_${pkgver//./_}/build
  make DESTDIR="${pkgdir}" install

  rm -rf "${pkgdir}/usr/bin"
  rm -rf "${pkgdir}/usr/share/man"
}
